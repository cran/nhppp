<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="TA Trikalinos, Y Sereda, S Chrysanthopoulou, F Alarid-Escudero" />

<meta name="date" content="2024-10-17" />

<title>A simple discrete event simulation model of a cancer’s natural history</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">A simple discrete event simulation model of
a cancer’s natural history</h1>
<h4 class="author">TA Trikalinos, Y Sereda, S Chrysanthopoulou, F
Alarid-Escudero</h4>
<h4 class="date">2024-10-17</h4>



<div id="the-simulation-world" class="section level2">
<h2>The simulation world</h2>
<p>We will model a cancer’s natural history in a population. We index
people by <span class="math inline">\(k \in [K] := \{1, \dots, K
\}\)</span>. The following assumptions fix a simulation world.</p>
<ol style="list-style-type: decimal">
<li><p>All types of events can be modeleld with nonhomogeneous Poisson
point processes (NHPPPs).</p></li>
<li><p>Persons are alive and cancer free at 40 years of age. No person
will live past 110 years. All people can die from causes other than the
cancer of interest (hereafter, <em>death from other causes</em>). Write
<span class="math inline">\(\rho_k(t)\)</span> for the corresponding
intensity function.</p></li>
<li><p>Some people may be exposed to an environmental toxin, with
exposure that varies over time. Write <span class="math inline">\(\xi_k(t) \ge 0\)</span> for the exposure function.
Positive values mean that a person is exposed at that particular
instance. (The never exposed have zeros throughout their life.) We will
assume that the exposure to said toxin is a risk factor only for cancer
emergence, and that the toxin has no cumulative effects – only the
instantaneous exposure levels matter. Write <span class="math inline">\(\delta_k\)</span> for the effect of the toxin
instantaneous exposure on developing cancer.</p></li>
<li><p>Some persons will develop a preclinical cancer with a
time-varying intensity function <span class="math inline">\(\lambda_{k}(t) =
\underbrace{\lambda_{k0}(t)}_{\textrm{non-risk factor part}} +
\underbrace{\delta_k \ \xi_k(t)}_{\textrm{risk factor
part}}\)</span>.</p></li>
<li><p>Some preclinical cancers may progress to clinical cancer with an
intensity function <span class="math inline">\(\mu_k(t)\)</span>, at
which point they are considered diagnosed.</p></li>
<li><p>Once people develop preclinical cancer they can die from cancer
with intensity function <span class="math inline">\(\nu_k(t)\)</span>.
The cancer death rate does not explicitly depend on whether the cancer
has been diagnosed or not. Thus, we have two competing causes of death:
death due to cancer and due to other causes.</p></li>
</ol>
</div>
<div id="setup" class="section level2">
<h2>Setup</h2>
<p>Load <code>nhppp</code> and <code>data.table</code>. (If you prefer
to not use <code>data.table</code>, you should be able to implement this
example in base <code>R</code> with little trouble.)</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(nhppp)</span></code></pre></div>
</div>
<div id="simulation-model" class="section level2">
<h2>Simulation model</h2>
<p>We now fix the mathematical description of the model. We will
simulate <span class="math inline">\(K = 10^{5}\)</span> males and
females (with equal probability) from the 2015 birth cohort.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>pop <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span>K,</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>  <span class="at">birth_cohort =</span> <span class="dv">2015</span>,</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>  <span class="at">spawn_age =</span> <span class="dv">40</span>,</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>  <span class="at">max_simulation_age =</span> <span class="dv">110</span>,</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>  <span class="at">sex =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">&quot;male&quot;</span>, <span class="st">&quot;female&quot;</span>), K, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>)</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="do">## It would make sense to execute the commented-out code now.</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="do">## It generates model parameters used in later stages.</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="do">## For expository clarity, we generate each parameter when it is introduced</span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a><span class="co"># pop[, `:=`(</span></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a><span class="co">#    param_cancer_emergence_shape = runif(.N, 7, 9),</span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a><span class="co">#    param_cancer_emergence_scale = rnorm(.N, 150, 20),</span></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a><span class="co">#    param_toxin_exposure_diff = pmax(0.005, rnorm(.N, 0.01, 0.005)),</span></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a><span class="co">#    param_cancer_death_intercept := rnorm(.N, -2, 0.5),</span></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a><span class="co">#    param_cancer_death_slope := runif(n= .N, min = 0, max = 0.003),</span></span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a><span class="co">#    param_clinical_cancer_dx_rate := runif(.N, 0.20, 0.27)</span></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a><span class="co">#  )]</span></span></code></pre></div>
<div id="death-from-other-causes" class="section level3">
<h3>Death from other causes</h3>
<p>The death from other causes <span class="math inline">\(\rho_k(t)\)</span> depends on the age (<span class="math inline">\(t\)</span>, measured in years), sex (male or
female), and birth year of person <span class="math inline">\(k\)</span>. Function <span class="math inline">\(\rho\)</span> is is a piecewise constant over each
year of age. It is a `regular’ step function (all steps have the same
length of one year).</p>
<p>If the cancer is not a major cause of death, then the intensity
function for all cause deaths is a good approximation for the intensity
function for death from other causes. The internal dataset
<code>annual_mortality_rates_2015</code> has all cause mortality data
for the 2015 birth cohort. It has the values of the piecewise constant
<span class="math inline">\(\rho\)</span> per birth cohort, sex, and
age. Here is a peek at some columns.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>annual_mortality_rates_2015[</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>  sex <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;male&quot;</span>, <span class="st">&quot;female&quot;</span>),</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>  <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">111</span><span class="sc">:</span><span class="dv">113</span>)</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>]</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co">#&gt; Key: &lt;birth_cohort, sex&gt;</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="co">#&gt;    birth_cohort    sex    age_0    age_1    age_2  age_108  age_109 age_110+</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="co">#&gt;           &lt;int&gt; &lt;fctr&gt;    &lt;num&gt;    &lt;num&gt;    &lt;num&gt;    &lt;num&gt;    &lt;num&gt;    &lt;num&gt;</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="co">#&gt; 1:         2015 female 0.005386 0.000350 0.000228 0.559371 0.541174 0.587413</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="co">#&gt; 2:         2015   male 0.006404 0.000452 0.000277 0.511677 0.671391 0.386100</span></span></code></pre></div>
<p>When we have a <em>step</em> (piecewise constant) intensity function
over <em>regular</em> time intervals (here, all one year long), we can
use <code>nhppp</code>’s <code>vdraw_sc_step_regular()</code> function.
We need to specify the following:</p>
<ol style="list-style-type: decimal">
<li>Pass the intensities as a matrix (argument
<code>lambda_matrix</code>); the number of columns in the matrix are the
number of time intervals in the step function.</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>rhos <span class="ot">&lt;-</span> annual_mortality_rates_2015[</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>  pop,</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>  on <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;birth_cohort&quot;</span>, <span class="st">&quot;sex&quot;</span>)</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>]</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="fu">setindex</span>(rhos, <span class="st">&quot;id&quot;</span>)</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>rho_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(rhos[, <span class="fu">c</span>(<span class="fu">paste0</span>(<span class="st">&quot;age_&quot;</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">109</span>), <span class="st">&quot;age_110+&quot;</span>),</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>  <span class="at">with =</span> <span class="cn">FALSE</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>])</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="st">&quot;rhos&quot;</span>) <span class="co"># cleanup</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li><p>Give information about how long each time step is, by specifying
the age bounds <code>rate_matrix_t_min</code> and
<code>rate_matrix_t_max</code> over which the intensity matrix
applies;</p></li>
<li><p>Optionally, if we want to sample times in a sub-interval of
<code>(rate_matrix_t_min, rate_matrix_t_max]</code>, we can specify even
narrower bounds, <code>t_min</code> and <code>t_max</code>. If you omit
<code>t_min</code> or <code>t_max</code>, the software uses
<code>rate_matrix_t_min</code> or <code>rate_matrix_t_max</code>,
respectively, to specify the sampling interval.</p></li>
<li><p>Because no person lives beyond the maximum simulation age of 110
years, we need to force the simulation of at least one death event over
the simulation interval. This means that we are sampling from a
zero-truncated NHPPP. Setting the option <code>atleast1</code> to
<code>TRUE</code> achieves this.</p></li>
<li><p>We only need to sample the earliest event from this NHPPP. So we
set the <code>atmost1</code> option to <code>TRUE</code>.</p></li>
</ol>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>pop[</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>  ,</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  age_dead_from_other_causes <span class="sc">:=</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>    nhppp<span class="sc">::</span><span class="fu">vdraw_sc_step_regular</span>(</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>      <span class="at">lambda_matrix =</span> rho_matrix,</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>      <span class="at">rate_matrix_t_min =</span> <span class="dv">0</span>,</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>      <span class="at">rate_matrix_t_max =</span> <span class="dv">110</span>,</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>      <span class="at">t_min =</span> pop<span class="sc">$</span>spawn_age, <span class="co"># 40</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>      <span class="at">t_max =</span> pop<span class="sc">$</span>max_simulation_age, <span class="co"># 110</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>      <span class="at">atmost1 =</span> <span class="cn">TRUE</span>,</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>      <span class="at">atleast1 =</span> <span class="cn">TRUE</span></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>    )</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>]</span></code></pre></div>
</div>
<div id="environmental-toxin-exposure-histories" class="section level3">
<h3>Environmental toxin exposure histories</h3>
<p>We will generate environmental exposure histories with a
phenomenological model. We will assume that</p>
<ol style="list-style-type: decimal">
<li><p>People may be exposed to the environmental toxin with probability
<span class="math inline">\(p_{start} = 0.20\)</span>.</p></li>
<li><p>For those who will be exposed, the start age of exposure is <span class="math inline">\(t_{k0} \sim U(12, 35)\)</span>, provided that they
are still alive.</p></li>
<li><p>Among those who are exposed, the probability that their exposure
will eventually stop is <span class="math inline">\(p_{stop} =
0.60\)</span>.</p></li>
<li><p>In the pertinent subgroup of persons, the duration of the
exposure is <span class="math inline">\(d_k \sim U(1, 35)\)</span>, if
they are still alive.</p></li>
<li><p>For people with at least some exposure to the toxin, for all
times in the exposure window <span class="math inline">\((t_{k0},
t_{k1}]\)</span> the exposure levels are <span class="math inline">\(\xi_k(t) = \Xi_k \cdot \Big(\frac{1}{2}
+\frac{1}{4}\big(\cos(0.5 t) + \cos(0.45 t) \big) \Big)\)</span>, where
<span class="math inline">\(t\)</span> is a person’s age and the
amplitude (maximum exposure) <span class="math inline">\(\Xi_k\)</span>
has model <span class="math inline">\(\Xi_k \sim U(0.2, 1)\)</span>.
Otherwise, <span class="math inline">\(\xi_k(t) = 0\)</span>.</p></li>
</ol>
<p>We now add the per-person parameters for exposure histories in the
population data.table. For people who will never be exposed we set <span class="math inline">\(\Xi_k\)</span> to zero, and their exposure start
and stop ages at the <code>max_simuation_age</code>. This avoids
<code>if ... else</code> statements, and is still pretty fast. If you
run a massive model, though, you may want to be smarter about it.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>pop[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>  <span class="at">exposure_start_age =</span> max_simulation_age,</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>  <span class="at">exposure_stop_age =</span> max_simulation_age,</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>  <span class="at">maximum_exposure =</span> <span class="dv">0</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>)][</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>  ,</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>  will_start_exposure <span class="sc">:=</span> <span class="fu">runif</span>(.N) <span class="sc">&lt;</span> <span class="fl">0.20</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>][</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>  will_start_exposure <span class="sc">==</span> <span class="cn">TRUE</span>,</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>  will_stop_exposure <span class="sc">:=</span> <span class="fu">runif</span>(.N) <span class="sc">&lt;</span> <span class="fl">0.60</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>][</span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>  will_start_exposure <span class="sc">==</span> <span class="cn">TRUE</span>,</span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>  exposure_start_age <span class="sc">:=</span> <span class="fu">pmin</span>(<span class="fu">runif</span>(.N, <span class="dv">12</span>, <span class="dv">35</span>), age_dead_from_other_causes)</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>][</span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>  will_stop_exposure <span class="sc">==</span> <span class="cn">TRUE</span>,</span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>  exposure_stop_age <span class="sc">:=</span> <span class="fu">pmin</span>(</span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>    exposure_start_age <span class="sc">+</span> <span class="fu">runif</span>(.N, <span class="dv">1</span>, <span class="dv">35</span>),</span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>    age_dead_from_other_causes</span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>  )</span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>][</span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>  will_start_exposure <span class="sc">==</span> <span class="cn">TRUE</span>,</span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>  maximum_exposure <span class="sc">:=</span> <span class="fu">runif</span>(.N, <span class="dv">1</span> <span class="sc">/</span> <span class="dv">5</span>, <span class="dv">1</span>)</span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>]</span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a><span class="co"># cleanup</span></span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a>pop[, will_start_exposure <span class="sc">:=</span> <span class="cn">NULL</span>][, will_stop_exposure <span class="sc">:=</span> <span class="cn">NULL</span>]</span></code></pre></div>
<p>We implement <span class="math inline">\(\xi_k(t)\)</span> as a
function that is vectorized over all its arguments. The arguments
<code>start_age</code>, <code>stop_age</code>, <code>max_exposure</code>
correspond to the variables <span class="math inline">\(t_{k0}, t_{k1},
\Xi\)</span> in the equation above.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>xi <span class="ot">&lt;-</span> toxin_exposure <span class="ot">&lt;-</span> <span class="cf">function</span>(t, max_exposure, start_age, stop_age) {</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  (start_age <span class="sc">&lt;=</span> t) <span class="sc">*</span> (stop_age <span class="sc">&gt;=</span> <span class="dv">1</span>) <span class="sc">*</span> max_exposure <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span> <span class="sc">+</span> (<span class="fu">cos</span>(t <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fu">cos</span>(<span class="fl">0.9</span> <span class="sc">*</span> t <span class="sc">/</span> <span class="dv">2</span>)) <span class="sc">/</span> <span class="dv">4</span>)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="emergence-of-pre-clinical-cancer-in-unexposed-and-exposed-intervals" class="section level3">
<h3>Emergence of pre-clinical cancer in unexposed and exposed
intervals</h3>
<p>Assume that the intensity function for cancer emergence in the
absence of toxin exposure is</p>
<p><span class="math inline">\(\lambda_{k0}(t) = \frac{shape_k}{scale_k}
\Big(\frac{t}{scale_k}\Big)^{shape_k -1}\)</span>,</p>
<p>where <span class="math inline">\(t\)</span> is age in years.</p>
<p>This intensity function generates a Weibull point process (a special
case of an NHPPP). The parameters <span class="math inline">\(shape_k\)</span> and <span class="math inline">\(scale_k\)</span> are assumed to vary across people
according to the models <span class="math inline">\(shape_k \sim U(7,
9)\)</span> and <span class="math inline">\(scale_k \sim N(150,
20)\)</span>, where <span class="math inline">\(U(\cdot)\)</span> and
<span class="math inline">\(N(\cdot)\)</span> stand for uniform and
normal distributions. We sample these values for each person in the
population.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>pop[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  <span class="at">param_cancer_emergence_shape =</span> <span class="fu">runif</span>(.N, <span class="dv">7</span>, <span class="dv">9</span>),</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>  <span class="at">param_cancer_emergence_scale =</span> <span class="fu">rnorm</span>(.N, <span class="dv">150</span>, <span class="dv">20</span>)</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>)]</span></code></pre></div>
<p>Generating a Weibull point process is easy in <code>R</code> using
the <code>stats::rweibull()</code> function. (This would take care of
the cancer emergence times for people without toxin exposure, but not
for people with toxin exposures.) Accounting for toxin exposure
histories, the intensity function for cancer emergence is <span class="math inline">\(\lambda_{k}(t) = l_{k0}(t) + \delta_k
\xi_k(t)\)</span>.</p>
<p>We will assume that the toxin exposure effect <span class="math inline">\(\delta_k\)</span> is distributed as <span class="math inline">\(\delta_k \sim N_+\big(2, 0.5\big)\)</span>, where
<span class="math inline">\(N_+(\cdot)\)</span> is a slab and smear
normal distribution.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>pop[, param_toxin_exposure_diff <span class="sc">:=</span> <span class="fu">pmax</span>(<span class="dv">0</span>, <span class="fu">rnorm</span>(.N, <span class="fl">0.01</span>, <span class="fl">0.005</span>))]</span></code></pre></div>
<p>We need to sample from an NHPPP with an intensity function that
varies over time as per <span class="math inline">\(\lambda_k(t)\)</span>. We will use
<code>nhppp</code>’s <code>vdraw_intensity()</code> function, which
needs</p>
<ol style="list-style-type: decimal">
<li><p>The intensity function (argument <code>lambda</code>) in a
vectorized form, so that age <span class="math inline">\(t\)</span> is
the only needed argument and all other arguments are set by
default.</p></li>
<li><p>A majorizer piecewise constant function, which will be specified
as a matrix <code>lambda_maj_matrix</code>.</p></li>
<li><p>The <code>rate_matrix_t_min</code>,
<code>rate_matrix_t_max</code> arguments that specify the time bounds
for the matrix <code>lambda_maj_matrix</code>.</p></li>
<li><p><code>t_min</code>, and <code>t_max</code> arguments, for the
subinterval over whchi we will sample times. Here,
<code>t_min = 40</code> – the spawn age in the simulation, and
<code>t_max</code> is the
<code>age_dead_from_other_causes</code>.</p></li>
</ol>
<p>Let’s implement the above.</p>
<p>The <em>intensity function</em> is specified as follows. Observe that
it is in vectorized form.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>lambda <span class="ot">&lt;-</span> <span class="cf">function</span>(t, <span class="at">P =</span> pop, ...) {</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>  <span class="co"># non-risk factor part: shape / scale * (t/scale)^(shape - 1)</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>  (P<span class="sc">$</span>param_cancer_emergence_shape <span class="sc">/</span> P<span class="sc">$</span>param_cancer_emergence_scale) <span class="sc">*</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>    (t <span class="sc">/</span> P<span class="sc">$</span>param_cancer_emergence_scale)<span class="sc">^</span>(P<span class="sc">$</span>param_cancer_emergence_shape <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>    <span class="co"># risk factor (toxin exposure) part: delta_k * xi(t)</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>    P<span class="sc">$</span>param_toxin_exposure_diff <span class="sc">*</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>      <span class="fu">xi</span>(</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>        <span class="at">t =</span> t,</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>        <span class="at">max_exposure =</span> P<span class="sc">$</span>maximum_exposure,</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>        <span class="at">start_age =</span> P<span class="sc">$</span>exposure_start_age,</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>        <span class="at">stop_age =</span> P<span class="sc">$</span>exposure_stop_age</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>      )</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>}</span></code></pre></div>
<p>We also need a piecewise constant <em>majorizer</em> function <span class="math inline">\(\lambda_*(t)\)</span>. We say that <span class="math inline">\(\lambda_*(t)\)</span> majorizes <span class="math inline">\(\lambda(t)\)</span> if <span class="math inline">\(\lambda_*(t) \ge \lambda(t)\)</span> for all <span class="math inline">\(t\)</span> of interest. The function expects a
<em>regular step</em> majorizer function. We will create such a function
with <span class="math inline">\(M = 10\)</span> equally-spaced
intervals over the whole simulation window. First, generate the
endpoints of the <span class="math inline">\(M\)</span> intervals. This
will be a matrix where the rows correspond to persons and the columns to
the <span class="math inline">\(M + 1 =11\)</span> interval bounds.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># define interval bounds for the step function, one row per person</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>time_breaks <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">rep</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">40</span>, <span class="at">to =</span> <span class="dv">110</span>, <span class="at">length.out =</span> M <span class="sc">+</span> <span class="dv">1</span>), <span class="at">each =</span> K),</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>  <span class="at">byrow =</span> <span class="cn">FALSE</span>,</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>  <span class="at">nrow =</span> K</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>)</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>time_breaks[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, ]</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="co">#&gt;      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11]</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="co">#&gt; [1,]   40   47   54   61   68   75   82   89   96   103   110</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="co">#&gt; [2,]   40   47   54   61   68   75   82   89   96   103   110</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a><span class="co">#&gt; [3,]   40   47   54   61   68   75   82   89   96   103   110</span></span></code></pre></div>
<p>… and now generate the majorizer matrix using <code>nhppp</code>’s
<code>get_step_majorizer()</code> function. (The paper in the
Bibliography explains how this function works.)</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>lambda_star <span class="ot">&lt;-</span> nhppp<span class="sc">::</span><span class="fu">get_step_majorizer</span>(</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>  <span class="at">fun =</span> lambda,</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>  <span class="at">breaks =</span> time_breaks,</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>  <span class="at">is_monotone =</span> <span class="cn">FALSE</span>,</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>  <span class="at">K =</span> <span class="fl">1.9</span> <span class="sc">/</span> <span class="dv">4</span> <span class="co"># This is the maximum slope of xi() -- which you get with some calculus</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>)</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>lambda_star[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, ]</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="co">#&gt;          [,1]     [,2]     [,3]     [,4]     [,5]     [,6]     [,7]     [,8]</span></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a><span class="co">#&gt; [1,] 1.664784 1.664424 1.664424 1.664554 1.665456 1.665944 1.667683 1.669700</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a><span class="co">#&gt; [2,] 1.662535 1.662590 1.662706 1.662929 1.663331 1.664018 1.665139 1.666900</span></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a><span class="co">#&gt; [3,] 1.662512 1.662533 1.662580 1.662677 1.662861 1.663191 1.663756 1.664682</span></span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a><span class="co">#&gt;          [,9]    [,10]</span></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a><span class="co">#&gt; [1,] 1.672383 1.677464</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a><span class="co">#&gt; [2,] 1.669577 1.673531</span></span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a><span class="co">#&gt; [3,] 1.666145 1.668387</span></span></code></pre></div>
<p>And now, we can sample the cancer generation times, and create a
variable to identify patients with cancer.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>pop[</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>  ,</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>  age_cancer_emergence <span class="sc">:=</span> nhppp<span class="sc">::</span><span class="fu">vdraw_intensity</span>(</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>    <span class="at">lambda =</span> lambda,</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>    <span class="at">lambda_maj_matrix =</span> lambda_star,</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>    <span class="at">rate_matrix_t_min =</span> <span class="dv">40</span>,</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>    <span class="at">rate_matrix_t_max =</span> <span class="dv">110</span>,</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>    <span class="at">t_min =</span> pop<span class="sc">$</span>spawn_age,</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>    <span class="at">t_max =</span> <span class="fu">pmin</span>(pop<span class="sc">$</span>age_dead_from_other_causes, <span class="dv">110</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>    <span class="at">atmost1 =</span> <span class="cn">TRUE</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>  )</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>][</span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>  ,</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>  with_cancer <span class="sc">:=</span> <span class="sc">!</span><span class="fu">is.na</span>(age_cancer_emergence),</span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>]</span></code></pre></div>
</div>
<div id="dying-from-cancer" class="section level3">
<h3>Dying from cancer</h3>
<p>People with preclinical cancer may die from cancer causes. We will
assume that the intensity from cancer deaths is loglinear in time, that
is</p>
<p><span class="math inline">\(\nu_k = e^{\alpha_k + \beta_k
t}\)</span>,</p>
<p>with parameters <span class="math inline">\(\alpha_k \sim N(-3,
0.2)\)</span> and <span class="math inline">\(\beta_k ~ U(0,
0.003)\)</span>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>pop[, param_cancer_death_intercept <span class="sc">:=</span> <span class="fu">rnorm</span>(.N, <span class="sc">-</span><span class="dv">3</span>, <span class="fl">0.2</span>)]</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>pop[, param_cancer_death_slope <span class="sc">:=</span> <span class="fu">runif</span>(.N, <span class="dv">0</span>, <span class="fl">0.003</span>)]</span></code></pre></div>
<p>We could use the <code>vdraw_intensity()</code> function again, since
we already know the intensity <span class="math inline">\(\nu_k\)</span>
and we can easily create a majorizer function for it, as we did when we
generated cancer emergence times. This would be plenty fast for our
small simulation with <span class="math inline">\(K = 10^{5}\)</span>
and requires no additional mathematics.</p>
<p>We can sample even faster if we can analytically obtain the
cumulative intensity function <span class="math inline">\(N_k(t) =
\int_0^t{\nu_k(s) \ \textrm{d}s}\)</span>, and its inverse <span class="math inline">\(N_k^{-1}(z)\)</span>. (The inverse function
recovers <span class="math inline">\(t\)</span> from the value of <span class="math inline">\(N_k(t)\)</span>: <span class="math inline">\(t =
N_k^{-1}\big( N_k(t)\big)\)</span>). This sampling is done with
<code>nhppp</code>’s <code>vdraw_cumulative_intensity()</code>
function.</p>
<p>A bit of calculus can yield <span class="math inline">\(N_k(t) =
\frac{1}{\beta_k} (e^{\alpha_k + \beta_k t} - e^{\alpha_k})\)</span>,
which we can implement in vectorized form and with default parameters
already set:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>Nu <span class="ot">&lt;-</span> <span class="cf">function</span>(t, <span class="at">Lambda_args =</span> <span class="fu">list</span>(population), ...) {</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>  P <span class="ot">&lt;-</span> Lambda_args<span class="sc">$</span>population</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>  (</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>    <span class="fu">exp</span>(P<span class="sc">$</span>param_cancer_death_intercept <span class="sc">+</span> P<span class="sc">$</span>param_cancer_death_slope <span class="sc">*</span> t) <span class="sc">-</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>      <span class="fu">exp</span>(P<span class="sc">$</span>param_cancer_death_intercept)</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>  ) <span class="sc">/</span> P<span class="sc">$</span>param_cancer_death_slope</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>}</span></code></pre></div>
<p>The inverse <span class="math inline">\(N_k^{-1}(\cdot)\)</span>
is</p>
<p>$N_k^{-1}(z) = ( ( _k z + e^_k ) - _k )/_k $</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>Nu_inv <span class="ot">&lt;-</span> <span class="cf">function</span>(z, <span class="at">Lambda_inv_args =</span> <span class="fu">list</span>(population), ...) {</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>  P <span class="ot">&lt;-</span> Lambda_inv_args<span class="sc">$</span>population</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>  (</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>    <span class="fu">log</span>(P<span class="sc">$</span>param_cancer_death_slope <span class="sc">*</span> z <span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>      <span class="fu">exp</span>(P<span class="sc">$</span>param_cancer_death_intercept)) <span class="sc">-</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>      P<span class="sc">$</span>param_cancer_death_intercept</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>  ) <span class="sc">/</span> P<span class="sc">$</span>param_cancer_death_slope</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>}</span></code></pre></div>
<p>Then, we can sample the times to cancer death.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>args_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">population =</span> pop[<span class="sc">!</span><span class="fu">is.na</span>(age_cancer_emergence), ])</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>pop[</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">is.na</span>(age_cancer_emergence),</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>  age_dead_from_cancer_causes <span class="sc">:=</span> nhppp<span class="sc">::</span><span class="fu">vdraw_cumulative_intensity</span>(</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>    <span class="at">Lambda =</span> Nu,</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>    <span class="at">Lambda_args =</span> args_list,</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>    <span class="at">Lambda_inv =</span> Nu_inv,</span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>    <span class="at">Lambda_inv_args =</span> args_list,</span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>    <span class="at">t_min =</span> pop[<span class="sc">!</span><span class="fu">is.na</span>(age_cancer_emergence), age_cancer_emergence],</span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>    <span class="at">t_max =</span> pop[<span class="sc">!</span><span class="fu">is.na</span>(age_cancer_emergence), age_dead_from_other_causes],</span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>    <span class="at">atmost1 =</span> <span class="cn">TRUE</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>  )</span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a>]</span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="st">&quot;args_list&quot;</span>) <span class="co"># cleanup</span></span></code></pre></div>
</div>
<div id="dying-from-all-causes" class="section level3">
<h3>Dying from all causes</h3>
<p>The age of death from all causes is the minimum of the ages across
both causes of death.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>pop[</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>  ,</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>  age_dead <span class="sc">:=</span> <span class="fu">pmin</span>(age_dead_from_other_causes,</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>    age_dead_from_cancer_causes,</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>    <span class="at">na.rm =</span> <span class="cn">TRUE</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>  )</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>]</span></code></pre></div>
</div>
<div id="clinical-cancer-diagnosis" class="section level3">
<h3>Clinical cancer diagnosis</h3>
<p>Cancers first emerge in a pre-clinical stage. Some will be diagnosed
as<br />
clinical cancers with intensity function <span class="math inline">\(\mu_k\)</span>. We will assume that clinical
diagnosis has constant rate which is distributed according to the
model</p>
<p><span class="math inline">\(\mu_k(t) := \mu_k \sim U(0.20,
0.27)\)</span>,</p>
<p>where <span class="math inline">\(k\)</span> indexes over people with
cancer.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>pop[</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">is.na</span>(age_cancer_emergence),</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>  param_clinical_cancer_dx_rate <span class="sc">:=</span> <span class="fu">runif</span>(.N, <span class="fl">0.20</span>, <span class="fl">0.27</span>)</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>]</span></code></pre></div>
<p>Constant rates result in exponential times, which we can easily
sample with the <code>stats::rexp()</code> function, as per the
commented out code below.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="do">### Using rexp()</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>tictoc<span class="sc">::</span><span class="fu">tic</span>()</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>pop[</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">is.na</span>(age_cancer_emergence),</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>  age_clinical_cancer_dx <span class="sc">:=</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>    age_cancer_emergence <span class="sc">+</span></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>    <span class="fu">rexp</span>(.N, <span class="at">rate =</span> param_clinical_cancer_dx_rate)</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>]</span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>pop[</span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a>  age_clinical_cancer_dx <span class="sc">&gt;=</span> age_dead,</span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>  age_clinical_cancer_dx <span class="sc">:=</span> <span class="cn">NA</span></span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a>]</span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a>tictoc<span class="sc">::</span><span class="fu">toc</span>()</span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a><span class="co">#&gt; 0.002 sec elapsed</span></span></code></pre></div>
<p>With <code>nhppp</code>, we can use the
<code>vdraw_sc_step_regular()</code> function that samples from
piecewise constant intensities. (A constant function over an interval is
still a piecewise constant function – with a single piece.) The
<code>nhppp</code> implementation will be only a bit slower – but it is
worth showing.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>tictoc<span class="sc">::</span><span class="fu">tic</span>()</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>mu_mat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(pop[</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">is.na</span>(age_cancer_emergence),</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>  param_clinical_cancer_dx_rate</span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>])</span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>pop[</span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>  <span class="sc">!</span><span class="fu">is.na</span>(age_cancer_emergence),</span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a>  age_clinical_cancer_dx <span class="sc">:=</span> nhppp<span class="sc">::</span><span class="fu">vdraw_sc_step_regular</span>(</span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a>    <span class="at">lambda_matrix =</span> mu_mat,</span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a>    <span class="at">rate_matrix_t_min =</span> pop[<span class="sc">!</span><span class="fu">is.na</span>(age_cancer_emergence), age_cancer_emergence],</span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a>    <span class="at">rate_matrix_t_max =</span> pop[<span class="sc">!</span><span class="fu">is.na</span>(age_cancer_emergence), age_dead],</span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a>    <span class="at">atmost1 =</span> <span class="cn">TRUE</span></span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a>  )</span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a>]</span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a>tictoc<span class="sc">::</span><span class="fu">toc</span>()</span>
<span id="cb21-17"><a href="#cb21-17" tabindex="-1"></a><span class="co">#&gt; 0.006 sec elapsed</span></span></code></pre></div>
</div>
</div>
<div id="some-descriptives" class="section level2">
<h2>Some descriptives</h2>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="co"># pop$age_cancer_emergence |&gt; summary()</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="fu">summary</span>(pop)</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a><span class="co">#&gt;        id          birth_cohort    spawn_age  max_simulation_age</span></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a><span class="co">#&gt;  Min.   :     1   Min.   :2015   Min.   :40   Min.   :110       </span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a><span class="co">#&gt;  1st Qu.: 25001   1st Qu.:2015   1st Qu.:40   1st Qu.:110       </span></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a><span class="co">#&gt;  Median : 50000   Median :2015   Median :40   Median :110       </span></span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a><span class="co">#&gt;  Mean   : 50000   Mean   :2015   Mean   :40   Mean   :110       </span></span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a><span class="co">#&gt;  3rd Qu.: 75000   3rd Qu.:2015   3rd Qu.:40   3rd Qu.:110       </span></span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a><span class="co">#&gt;  Max.   :100000   Max.   :2015   Max.   :40   Max.   :110       </span></span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a><span class="co">#&gt;                                                                 </span></span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a><span class="co">#&gt;      sex            age_dead_from_other_causes exposure_start_age</span></span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a><span class="co">#&gt;  Length:100000      Min.   : 40.01             Min.   : 12.00    </span></span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a><span class="co">#&gt;  Class :character   1st Qu.: 72.82             1st Qu.:110.00    </span></span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a><span class="co">#&gt;  Mode  :character   Median : 82.57             Median :110.00    </span></span>
<span id="cb22-15"><a href="#cb22-15" tabindex="-1"></a><span class="co">#&gt;                     Mean   : 80.20             Mean   : 92.69    </span></span>
<span id="cb22-16"><a href="#cb22-16" tabindex="-1"></a><span class="co">#&gt;                     3rd Qu.: 89.58             3rd Qu.:110.00    </span></span>
<span id="cb22-17"><a href="#cb22-17" tabindex="-1"></a><span class="co">#&gt;                     Max.   :109.87             Max.   :110.00    </span></span>
<span id="cb22-18"><a href="#cb22-18" tabindex="-1"></a><span class="co">#&gt;                                                                  </span></span>
<span id="cb22-19"><a href="#cb22-19" tabindex="-1"></a><span class="co">#&gt;  exposure_stop_age maximum_exposure param_cancer_emergence_shape</span></span>
<span id="cb22-20"><a href="#cb22-20" tabindex="-1"></a><span class="co">#&gt;  Min.   : 13.32    Min.   :0.00     Min.   :7.000               </span></span>
<span id="cb22-21"><a href="#cb22-21" tabindex="-1"></a><span class="co">#&gt;  1st Qu.:110.00    1st Qu.:0.00     1st Qu.:7.501               </span></span>
<span id="cb22-22"><a href="#cb22-22" tabindex="-1"></a><span class="co">#&gt;  Median :110.00    Median :0.00     Median :8.002               </span></span>
<span id="cb22-23"><a href="#cb22-23" tabindex="-1"></a><span class="co">#&gt;  Mean   :101.76    Mean   :0.12     Mean   :8.001               </span></span>
<span id="cb22-24"><a href="#cb22-24" tabindex="-1"></a><span class="co">#&gt;  3rd Qu.:110.00    3rd Qu.:0.00     3rd Qu.:8.502               </span></span>
<span id="cb22-25"><a href="#cb22-25" tabindex="-1"></a><span class="co">#&gt;  Max.   :110.00    Max.   :1.00     Max.   :9.000               </span></span>
<span id="cb22-26"><a href="#cb22-26" tabindex="-1"></a><span class="co">#&gt;                                                                 </span></span>
<span id="cb22-27"><a href="#cb22-27" tabindex="-1"></a><span class="co">#&gt;  param_cancer_emergence_scale param_toxin_exposure_diff age_cancer_emergence</span></span>
<span id="cb22-28"><a href="#cb22-28" tabindex="-1"></a><span class="co">#&gt;  Min.   : 67.46               Min.   :0.000000          Min.   : 40.01      </span></span>
<span id="cb22-29"><a href="#cb22-29" tabindex="-1"></a><span class="co">#&gt;  1st Qu.:136.42               1st Qu.:0.006624          1st Qu.: 57.42      </span></span>
<span id="cb22-30"><a href="#cb22-30" tabindex="-1"></a><span class="co">#&gt;  Median :149.99               Median :0.010004          Median : 72.15      </span></span>
<span id="cb22-31"><a href="#cb22-31" tabindex="-1"></a><span class="co">#&gt;  Mean   :149.94               Mean   :0.010052          Mean   : 70.12      </span></span>
<span id="cb22-32"><a href="#cb22-32" tabindex="-1"></a><span class="co">#&gt;  3rd Qu.:163.48               3rd Qu.:0.013392          3rd Qu.: 82.73      </span></span>
<span id="cb22-33"><a href="#cb22-33" tabindex="-1"></a><span class="co">#&gt;  Max.   :234.05               Max.   :0.032101          Max.   :107.68      </span></span>
<span id="cb22-34"><a href="#cb22-34" tabindex="-1"></a><span class="co">#&gt;                                                         NA&#39;s   :95613       </span></span>
<span id="cb22-35"><a href="#cb22-35" tabindex="-1"></a><span class="co">#&gt;  with_cancer     param_cancer_death_intercept param_cancer_death_slope</span></span>
<span id="cb22-36"><a href="#cb22-36" tabindex="-1"></a><span class="co">#&gt;  Mode :logical   Min.   :-3.817               Min.   :3.500e-09       </span></span>
<span id="cb22-37"><a href="#cb22-37" tabindex="-1"></a><span class="co">#&gt;  FALSE:95613     1st Qu.:-3.134               1st Qu.:7.468e-04       </span></span>
<span id="cb22-38"><a href="#cb22-38" tabindex="-1"></a><span class="co">#&gt;  TRUE :4387      Median :-3.000               Median :1.507e-03       </span></span>
<span id="cb22-39"><a href="#cb22-39" tabindex="-1"></a><span class="co">#&gt;                  Mean   :-3.000               Mean   :1.502e-03       </span></span>
<span id="cb22-40"><a href="#cb22-40" tabindex="-1"></a><span class="co">#&gt;                  3rd Qu.:-2.866               3rd Qu.:2.257e-03       </span></span>
<span id="cb22-41"><a href="#cb22-41" tabindex="-1"></a><span class="co">#&gt;                  Max.   :-2.140               Max.   :3.000e-03       </span></span>
<span id="cb22-42"><a href="#cb22-42" tabindex="-1"></a><span class="co">#&gt;                                                                       </span></span>
<span id="cb22-43"><a href="#cb22-43" tabindex="-1"></a><span class="co">#&gt;  age_dead_from_cancer_causes    age_dead      param_clinical_cancer_dx_rate</span></span>
<span id="cb22-44"><a href="#cb22-44" tabindex="-1"></a><span class="co">#&gt;  Min.   : 40.20              Min.   : 40.01   Min.   :0.20                 </span></span>
<span id="cb22-45"><a href="#cb22-45" tabindex="-1"></a><span class="co">#&gt;  1st Qu.: 61.91              1st Qu.: 72.35   1st Qu.:0.22                 </span></span>
<span id="cb22-46"><a href="#cb22-46" tabindex="-1"></a><span class="co">#&gt;  Median : 73.63              Median : 82.26   Median :0.24                 </span></span>
<span id="cb22-47"><a href="#cb22-47" tabindex="-1"></a><span class="co">#&gt;  Mean   : 72.40              Mean   : 79.87   Mean   :0.24                 </span></span>
<span id="cb22-48"><a href="#cb22-48" tabindex="-1"></a><span class="co">#&gt;  3rd Qu.: 83.16              3rd Qu.: 89.36   3rd Qu.:0.25                 </span></span>
<span id="cb22-49"><a href="#cb22-49" tabindex="-1"></a><span class="co">#&gt;  Max.   :108.17              Max.   :109.87   Max.   :0.27                 </span></span>
<span id="cb22-50"><a href="#cb22-50" tabindex="-1"></a><span class="co">#&gt;  NA&#39;s   :97768                                NA&#39;s   :95613                </span></span>
<span id="cb22-51"><a href="#cb22-51" tabindex="-1"></a><span class="co">#&gt;  age_clinical_cancer_dx</span></span>
<span id="cb22-52"><a href="#cb22-52" tabindex="-1"></a><span class="co">#&gt;  Min.   : 40.31        </span></span>
<span id="cb22-53"><a href="#cb22-53" tabindex="-1"></a><span class="co">#&gt;  1st Qu.: 58.56        </span></span>
<span id="cb22-54"><a href="#cb22-54" tabindex="-1"></a><span class="co">#&gt;  Median : 72.68        </span></span>
<span id="cb22-55"><a href="#cb22-55" tabindex="-1"></a><span class="co">#&gt;  Mean   : 70.95        </span></span>
<span id="cb22-56"><a href="#cb22-56" tabindex="-1"></a><span class="co">#&gt;  3rd Qu.: 82.96        </span></span>
<span id="cb22-57"><a href="#cb22-57" tabindex="-1"></a><span class="co">#&gt;  Max.   :106.46        </span></span>
<span id="cb22-58"><a href="#cb22-58" tabindex="-1"></a><span class="co">#&gt;  NA&#39;s   :96980</span></span></code></pre></div>
</div>
<div id="bibliography" class="section level2">
<h2>Bibliography</h2>
<p>Trikalinos TA, Sereda Y. <em>nhppp: Simulating Nonhomogeneous Poisson
Point Processes in R</em>. arXiv preprint arXiv:2402.00358. 2024 Feb
1.</p>
<p>Since the publication of the paper, the syntax and options of the
<code>nhppp</code> package have evolved. To reproduce the code in the
paper, you have to install the version of <code>nhppp</code> used in the
paper. Alternatively, take a look at the vignettes, which are written to
work with the current package.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
